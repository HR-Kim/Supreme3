<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="kr.co.supreme.orderStatus">
  <sql id="orderStatusColumns">
		O3.DETAIL_CODE as detail_code ,
		O2.ORDER_CODE as order_code ,
		P.P_IMAGE 이미지,
		P.P_NAME 상품명,
		P.P_CONTENT 상품설명,
		O2.QUANTITY 수량,
		O3.OD_STATUS as od_status,
		O3.UDT_DT as udt_dt
  </sql>
  
 <sql id="baseCondition">
			<choose>
				<when test="'10' == searchDiv">
					and TITLE LIKE '%' || #{searchWord} || '%'
				</when>
				<when test="'20' == searchDiv">
					and CONTENTS LIKE '%' || #{searchWord} || '%'
				</when>
				<when test="'30' == searchDiv">
					and REG_ID LIKE '%' || #{searchWord} || '%'
				</when>
				<otherwise></otherwise>							
			</choose>
	</sql>
	<!-- 목록조회 -->
   <select id="get_retrieve" parameterType="Search" resultType="OrderStatus">
          SELECT T1.*,T2.*													
		  FROM                                                              
			  (                                                           
			  	SELECT *            
		      FROM                                                           
			  	( 	SELECT ROWNUM AS rnum, A.*         
		           FROM 
		           ( SELECT 
		             U.NICKNAME as nickname,
		             O1.ORDER_CODE as order_code,
		             O3.DETAIL_CODE as detail_code ,
		             P.P_IMAGE as pImage,
		             P.P_NAME as pName,
		             P.P_CONTENT as pContent, 
		             O3.OD_STATUS as od_status                                                            
			  			FROM   
						  USERS U JOIN ORDERS O1
							ON U.ID = O1.ID         
							JOIN ORDER_DETAIL O2
							ON O1.ORDER_CODE = O2.ORDER_CODE
							JOIN ORDER_STATUS O3
							ON O3.DETAIL_CODE = O2.DETAIL_CODE
							JOIN PRODUCT P 
							ON O2.P_CODE = P.P_CODE		                     
			  			AND udt_dt <![CDATA[ >  ]]> to_date('19700101','yyyymmdd')     
			  			ORDER BY udt_dt DESC                                   
			  		)A                                                         
			  	   WHERE ROWNUM <![CDATA[ <= ]]>(#{pageSize} * (#{pageNum}-1)+#{pageSize})   						       
			  	) B                                                            
			  	WHERE B.rnum <![CDATA[ >= ]]> (#{pageSize} * (#{pageNum}-1)+1)                    				   
			  )T1
			  NATURAL JOIN                                                      
			  (                                                                 
			      SELECT COUNT(*) totalCnt                                     
		         FROM order_Status       
		         WHERE  1=1      
		                                                    		                               
		  )T2  

   </select>
	<!-- get_boardIdList -->
	<select id="get_orderStatusList" parameterType="Search" resultType="OrderStatus">
		SELECT
		   	DETAIL_CODE,  
			OD_STATUS,     
			REG_DT,        
			UDT_DT  
		FROM
		    ORDER_STATUS
		WHERE DETAIL_CODE LIKE '%' || #{searchWord} || '%'
		ORDER BY DETAIL_CODE ASC
	</select>
	

	<!-- 단건조회 -->
	<select id="get_selectOne" parameterType="OrderStatus"
		resultType="OrderStatus">
		SELECT 
		<include refid="orderStatusColumns" />
		FROM 
			USERS U JOIN ORDERS O1
			ON U.ID = O1.ID
			JOIN ORDER_DETAIL O2
			ON O1.ORDER_CODE = O2.ORDER_CODE
			JOIN ORDER_STATUS O3
			ON O3.DETAIL_CODE = O2.DETAIL_CODE
			JOIN PRODUCT P 
			ON O2.P_CODE = P.P_CODE
		WHERE O3.DETAIL_CODE = 
		#{detail_code,jdbcType=VARCHAR}
	</select>
	
	<!-- 수정 -->
	<update id="do_update" parameterType="OrderStatus">
	UPDATE ORDER_STATUS 
	SET 
		OD_STATUS =#{od_status,jdbcType=VARCHAR},
		UDT_DT = SYSDATE 
	WHERE
		detail_code=#{detail_code,jdbcType=VARCHAR}
	</update>
	
	<!-- 삭제  -->
	<delete id="do_delete" parameterType="OrderStatus">
	DELETE FROM ORDER_STATUS WHERE DETAIL_CODE=#{detail_code,jdbcType=VARCHAR}
	</delete>
	
	<!-- 등록 -->
	<insert id="do_save" parameterType="User">
		INSERT INTO ORDER_STATUS (
		   DETAIL_CODE,  
			OD_STATUS,     
			REG_DT,        
			UDT_DT 
		) VALUES (
		    #{detail_code,jdbcType=VARCHAR},
		    #{od_status,jdbcType=VARCHAR},
		    SYSDATE,
		    #{udt_dt,jdbcType=VARCHAR}
		) 
	</insert>
</mapper>